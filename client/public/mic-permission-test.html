<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aro-Ha Chat - Microphone Permission Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    
    h1, h2, h3 {
      color: #8E8F70;
    }
    
    .content {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .info-box {
      background-color: #e8f4fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    .usage-steps {
      list-style-type: decimal;
      padding-left: 20px;
    }
    
    .usage-steps li {
      margin-bottom: 10px;
    }
    
    button {
      background-color: #8E8F70;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      margin: 10px 10px 10px 0;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #767657;
    }
    
    pre {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
    }
    
    .muted {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Aro-Ha Chat - Microphone Permission Test</h1>
  
  <div class="content">
    <h2>Microphone Permission Flow</h2>
    <p>This page demonstrates the Aro-Ha chat widget with improved microphone permission handling. The widget now properly requests microphone permissions before using voice features.</p>
    
    <div class="info-box">
      <h3>How it works:</h3>
      <ol class="usage-steps">
        <li>When you click the chat button, the widget checks if microphone permissions are already granted</li>
        <li>If not already granted, a permission dialog appears asking for permission</li>
        <li>Clicking "Allow Microphone" triggers the browser's permission prompt</li>
        <li>The chat widget then opens with the appropriate permissions</li>
        <li>If you click "Cancel", the chat still opens but without microphone access</li>
      </ol>
    </div>
  </div>
  
  <div class="content">
    <h2>Test Instructions</h2>
    <p>To test this implementation:</p>
    <ol>
      <li>Click the chat button in the lower right corner</li>
      <li>You should see a permission dialog</li>
      <li>Click "Allow Microphone" and accept the browser's permission prompt</li>
      <li>The chat widget should open with microphone access enabled</li>
      <li>Try using the voice call feature - it should work without showing the previous error</li>
    </ol>
    
    <p class="muted">Note: If you've already granted microphone permissions, the dialog will be skipped and the chat will open directly.</p>
  </div>
  
  <div class="content">
    <h2>Webflow Integration Code</h2>
    <p>The code below should be added to Webflow's Custom Code section in Site Settings:</p>
    
    <pre>&lt;script src="https://arohaunifiedchat.replit.app/aro-ha-webflow-mic-permission.js"&gt;&lt;/script&gt;</pre>
    
    <p>This implementation will properly handle microphone permissions while maintaining the same visual style and functionality as the original widget.</p>
  </div>
  
  <!-- Include the micophone permission script -->
  <script>
  /**
   * Aro-Ha AI Assistant Widget - Webflow Embed Code with Microphone Permissions
   * Based on the direct-test.html implementation with added microphone permission handling
   */
  (function() {
    // Create and inject CSS
    const style = document.createElement('style');
    style.textContent = `
      /* Widget Styles */
      .chat-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #8E8F70;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.8);
      }
      
      .chat-button svg {
        width: 30px;
        height: 30px;
        fill: white;
      }
      
      .chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 380px;
        height: 580px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 40px rgba(0,0,0,0.16);
        z-index: 9998;
        display: none;
      }
      
      .chat-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      
      /* Permission Dialog Styles */
      .permission-dialog {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 380px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 40px rgba(0,0,0,0.16);
        z-index: 10000;
        display: none;
        padding: 20px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .permission-dialog h3 {
        margin-top: 0;
        color: #8E8F70;
      }
      
      .permission-dialog p {
        margin-bottom: 20px;
        line-height: 1.5;
      }
      
      .permission-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .permission-button {
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        border: none;
      }
      
      .permission-button.primary {
        background-color: #8E8F70;
        color: white;
      }
      
      .permission-button.secondary {
        background-color: #f1f1f1;
        color: #333;
      }
      
      @media (max-width: 768px) {
        .chat-container, .permission-dialog {
          width: 100vw;
          height: 100vh;
          bottom: 0;
          right: 0;
          border-radius: 0;
        }
        
        .permission-dialog {
          height: auto;
          max-height: 100vh;
        }
      }
    `;
    document.head.appendChild(style);

    // Create chat button
    const chatButton = document.createElement('div');
    chatButton.className = 'chat-button';
    chatButton.id = 'chatButton';
    chatButton.innerHTML = `
      <svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <!-- MessageSquare from Lucide (minimal chat icon - outline only) -->
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    `;
    document.body.appendChild(chatButton);

    // Create chat container
    const chatContainer = document.createElement('div');
    chatContainer.className = 'chat-container';
    chatContainer.id = 'chatContainer';
    document.body.appendChild(chatContainer);
    
    // Create permission dialog
    const permissionDialog = document.createElement('div');
    permissionDialog.className = 'permission-dialog';
    permissionDialog.id = 'permissionDialog';
    permissionDialog.innerHTML = `
      <h3>Microphone Access Required</h3>
      <p>To use voice features in our chat, your browser needs permission to access your microphone. When prompted, please select "Allow" to enable voice interactions.</p>
      <div class="permission-actions">
        <button id="permissionCancel" class="permission-button secondary">Cancel</button>
        <button id="permissionAllow" class="permission-button primary">Allow Microphone</button>
      </div>
    `;
    document.body.appendChild(permissionDialog);

    // Microphone permission state
    let micPermissionState = null;
    let iframeCreated = false;

    // Check if microphone is already permitted
    async function checkMicrophonePermission() {
      try {
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        return permissionStatus.state;
      } catch (error) {
        console.log('Could not check permission state:', error);
        return 'unknown';
      }
    }

    // Request microphone permission
    async function requestMicrophonePermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Stop the stream immediately after getting permission
        stream.getTracks().forEach(track => track.stop());
        return 'granted';
      } catch (error) {
        console.log('Microphone permission denied:', error);
        return 'denied';
      }
    }

    // Create iframe with proper permissions
    function createChatIframe() {
      if (iframeCreated) return;
      
      const chatIframe = document.createElement('iframe');
      chatIframe.src = window.location.origin + '/widget-full';
      chatIframe.title = 'Aro Ha Chat';
      // Explicitly allow microphone
      chatIframe.allow = 'microphone; autoplay';
      chatContainer.appendChild(chatIframe);
      iframeCreated = true;
    }

    // Show the chat widget
    function showChat() {
      chatButton.style.display = 'none';
      permissionDialog.style.display = 'none';
      createChatIframe();
      chatContainer.style.display = 'block';
    }

    // Set up event listeners after DOM is fully loaded
    async function setupEventListeners() {
      // Check initial microphone permission
      micPermissionState = await checkMicrophonePermission();
      
      // Chat button click handler
      chatButton.addEventListener('click', async function() {
        if (micPermissionState === 'granted') {
          // If microphone is already allowed, just show the chat
          showChat();
        } else {
          // Otherwise show the permission dialog first
          chatButton.style.display = 'none';
          permissionDialog.style.display = 'block';
        }
      });
      
      // Permission dialog button handlers
      document.getElementById('permissionAllow').addEventListener('click', async function() {
        // Request microphone permission
        micPermissionState = await requestMicrophonePermission();
        
        if (micPermissionState === 'granted') {
          showChat();
        } else {
          // If denied, show an alert and close the dialog
          alert('Microphone permission was denied. Voice features will not work. You can change this in your browser settings.');
          permissionDialog.style.display = 'none';
          showChat(); // Show chat anyway, but without mic
        }
      });
      
      document.getElementById('permissionCancel').addEventListener('click', function() {
        // User cancelled, show chat anyway
        permissionDialog.style.display = 'none';
        showChat();
      });
      
      // Listen for close message from the chat iframe
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'widget-close') {
          chatContainer.style.display = 'none';
          chatButton.style.display = 'flex';
        }
        
        // Listen for voice call starting
        if (event.data && event.data.type === 'voice-call-starting') {
          // Request mic permission if not already granted
          if (micPermissionState !== 'granted') {
            requestMicrophonePermission().then(state => {
              micPermissionState = state;
              // Notify the iframe of the new permission state
              const iframe = document.querySelector('.chat-container iframe');
              if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'mic-permission-update', state: micPermissionState }, '*');
              }
            });
          }
        }
      });
    }

    // Initialize when DOM is fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupEventListeners);
    } else {
      setupEventListeners();
    }
  })();
  </script>
</body>
</html>